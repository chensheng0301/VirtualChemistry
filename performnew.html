<!DOCTYPE html>
<html lang="en">
<head>
  <title>ekshikhsha</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <script type="text/javascript" src="libs/three.js"></script>
    <script type="text/javascript" src="Objects/Objects.js"></script>
    <script type="text/javascript" src="Objects/Interactions.js"></script>    
    <script type="text/javascript" src="libs/ThreeBSP.js"></script>
    <script src="libs/OrbitControls.js"></script>  
    <script src="libs/DragControls.js"></script>
  <style>
    /* Remove the navbar's default margin-bottom and rounded borders */ 
    .navbar {
      margin-bottom: 0;
      border-radius: 0;
    }
    
    /* Add a gray background color and some padding to the footer */
    footer {
      background-color: #f2f2f2;
      padding: 25px;
    }
    
    .jumbotron{
    background-image:url("chem.jpg");
    }
    .largebox{
      width:1300px;
      height:900px;
      top:-20px;
      margin-left:-80px;
       position:relative;
        border:1px solid black;
        border-radius:3px;
        margin-top:50px;
        background-color:#343436;
         box-shadow: 2px 2px 4px black;

        }
      .largebox2{
      width:400px;
      height:300px;
      border:1px solid black;
      border-radius:3px;
      margin-left:75px;
      margin-top:80px;
      background-color:white;
      box-shadow: 2px 2px 4px black;
    
      }
      #canvas1{
      border:1px solid black;
      margin-left:75px;
      margin-top:20px;
      border-radius:3px;
      background-color:white;
       box-shadow: 2px 2px 4px black;

      }
      #selectbox{
      width:200px;
      height:30px;
      margin-left:100px;
      margin-top:10px;
      }
      #canvas2{
      border:1px solid black;
      border-radius:3px;
      position:relative;
      top:-728px;
      margin-left:520px;
      background-color:white;
       box-shadow: 2px 2px 4px black;

      }
      
       #selectbox2{
      width:200px;
      height:30px;
      margin-left:10px;
      margin-top:10px;
      }
      #add{
      margin-left:348px;
      margin-bottom:-104px;
     
      }
  </style>
</head>
<body>

<nav class="navbar navbar-fixed-top" style="background-color:black;">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>                        
      </button>
      <a class="navbar-brand" href="#" style="color:white">ekshikhsha</a>
    </div>
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav">
        <li class="active" ><a href="#" style="color:white">Home</a></li>
        <li><a href="#" style="color:white">About</a></li>
        <li><a href="#" style="color:white">Join us</a></li>
    <li> <select id="selectbox">
   <option selected hidden>Choose equipments</option>
  <option value="#consumergoods">Test tube</option>
  <option value="#consumergoods2">Beaker</option>
  <option value="#consumergoods2">Burner</option>
  <option value="#consumergoods">Flask</option>
  <option value="#consumergoods">Pipette</option>
  <option value="#consumergoods2">Test Tube stand</option>
  <option value="#consumergoods2">Bottles</option>
  <option value="#consumergoods">Burette</option>
  <option value="#consumergoods2">Wash Basin</option>
</select></li>
<li><select id="selectbox2">
  <option selected hidden>Choose chemicals</option>
  <optgroup label="Acids">
  <option value="#consumer_goods">Hydrochloric acid</option>
  <option value="#consumer_goods">Sulphuric acid</option>
  <option value="#consumer_goods">Phosphoric acid</option>
  <optgroup label="Bases">
  <option value="#consumer_goods">Sodium Hydroxide</option>
  <option value="#consumer_goods">Ammonium Hydroxide</option>
  <optgroup label="Indicators">
  <option>Methyl orange</option>
  <option>Phenolphthalein</option>
  <option>Red litmus</option>
  <option>Blue litmus</option>
    
</select></li>
<li><button class="btn btn-primary" id ="Save" style="margin-top:8px;margin-right:10px;margin-left:50px">Save</button></li>
<li><button class="btn btn-primary" id = "Restore" style="margin-top:8px;margin-right:10px;margin-left:10px">Restore</button></li>
<li><button class="btn btn-primary" id="NewTable" style="margin-top:8px;margin-right:10px;margin-left:10px">New table</button></li>   
      </ul>
    </div>
  </div>
</nav>
<script>
$("#selectbox").change(function () {
    if ($(this).val() == "#consumergoods") {
        $('#consumergoods').modal('show');
      }
    if ($(this).val() == "#consumergoods2") {
        $('#consumergoods2').modal('show');
      }
    
 });
</script>
<div class="modal fade" id="consumergoods" data-target="#consumergoods">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header orange">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>

        </button>
        <h4 class="modal-title">Provide details</h4>
        <p><input type="text" class="form-control" id="text1" placeholder="Enter number">
    <input type="text" class="form-control" id="text2" placeholder="Enter volume in mL" style="margin-top:20px">
    </p>
    <button type="button" class="btn btn-primary"  action="#">Submit</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="consumergoods2" data-target="#consumergoods2">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header orange">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>

        </button>
        <h4 class="modal-title">Provide details</h4>
        <p><input type="text" class="form-control" id="text1" placeholder="Enter number">
    </p>
    <button type="button" class="btn btn-primary"  action="#">Submit</button>
    </div>
  </div>
</div>

</div>
<script>
$("#selectbox2").change(function () {
    if ($(this).val() == "#consumer_goods") {
        $('#consumer_goods').modal('show');
      }
});
</script>
<div class="modal fade" id="consumer_goods" data-target="#consumer_goods">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header orange">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>

        </button>
        <p><h4 class="modal-title">Provide details</h4></p>
        <form action="#" method="$POST">
    <input type="text" class="form-control" id="text1" placeholder="Enter volume in mL">
    <input type="text" class="form-control" id="text2" placeholder="Enter Normality" style="margin-top:20px"><br>
    <button type="button" class="btn btn-primary"  action="#">Submit</button>
    
    </form>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  var drag=1;
    var pressobjects=[];
    var pressmap=[];
    var prevcor;
    var prevmaster;
    var prevslot;
    var scene,camera,renderer;
    var basin_width=30;
    var objects=[];
    var objectsM=[];
    var objectsC=[];
    var table_n;
    var table_height=50;
    var basin_height=50;
    var shelf_height=table_height;
    var tables=[];
    var basins=[];
    var shelves=[];
    var spotLight=[];
    var dobject=null;
    var pobject=null;
    var dirLight;
    var journal=[];
    var isclick=1;
    var raycaster = new THREE.Raycaster();
    var mouse = new THREE.Vector2();
    function init() {
        scene = new THREE.Scene();
        // create a camera, which defines where we're looking at.
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        // create a render and set the size
        renderer = new THREE.WebGLRenderer();
        renderer.setClearColor(new THREE.Color(0x436521, 1));
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMapEnabled = true;
        // add subtle ambient lighting
        var ambientLight = new THREE.AmbientLight(0x0c0c0c,1);
        scene.add(ambientLight);
        // add spotlight for the shadows
        document.body.appendChild(renderer.domElement);
        var controls = new THREE.OrbitControls( camera, renderer.domElement );
        //This data has to be taken from the database
        shelves.push(new Shelf(shelf_height));
        shelves[0].setPosition(0,0,-table_height*2/5);
        table_n=2;
        //instantiate(new Beaker(250,150,"blue"));
        var nmix=new Mixture(undefined,undefined,150,['HCl'],[1],['red'],[1],[1]);
        var base=new Mixture(undefined,undefined,80,['NaOH'],[1],['green'],[1],[1]);
        var wat=new Mixture(undefined,undefined,80,[],[],[],[],[])
        instantiate(new Flask(250,nmix));
        move(objects[0],-10,0,0);
        instantiate(new Beaker(100,wat));
        move(objects[objects.length-1],new THREE.Vector3(25,0,0));
        wat=new Mixture(undefined,undefined,80,[],[],[],[],[]);
        instantiate(new Bottle(250,wat));
        move(objects[objects.length-1],nextShelfSlot());
        wat=new Mixture(undefined,undefined,80,[],[],[],[],[]);
        instantiate(new Bottle(250,wat));
        move(objects[objects.length-1],nextShelfSlot());
        wat=new Mixture(undefined,undefined,80,[],[],[],[],[]);
        instantiate(new Bottle(250,wat));
        move(objects[objects.length-1],nextShelfSlot());
        wat=new Mixture(undefined,undefined,80,[],[],[],[],[]);
        instantiate(new Bottle(100,wat));
        move(objects[objects.length-1],nextShelfSlot());
        wat=new Mixture(undefined,undefined,80,[],[],[],[],[]);
        instantiate(new Bottle(250,wat));
        move(objects[objects.length-1],nextShelfSlot());
        wat=new Mixture(undefined,undefined,80,[],[],[],[],[]);
        instantiate(new Bottle(250,wat));
        move(objects[objects.length-1],new THREE.Vector3(0,0,0));
        wat=new Mixture(undefined,undefined,80,[],[],[],[],[]);
        var xflask=new Bottle(250,wat);
        instantiate(xflask);
        move(objects[objects.length-1],new THREE.Vector3(15,0,0));
        shelves.pop();
        wat=new Mixture(undefined,undefined,20,[],[],[],[],[]);
        var xwatch=new WatchGlass(50,wat);
        instantiate(xwatch);
        move(objects[objects.length-1],120,0,0);
        wat=new Mixture(undefined,undefined,100,[],[],[],[],[]);
        var xbstand=new Burette(100,base);
        instantiate(xbstand);
        move(objects[objects.length-1],new THREE.Vector3(170,0,0));
        var xpip=new Pipette(10);
        instantiate(xpip);
        move(objects[objects.length-1],new THREE.Vector3(40,0,0));
        var xtable=new Table(5);
        //End
        for(var i=0;i<table_n;i++){
          spotLight.push(new THREE.PointLight(0xffffff,1,0,1),);
          spotLight[i].position.set(i*table_height*2+i*basin_width, 80, -60);
          spotLight[i].castShadow = true;
          scene.add(spotLight[i]);
        }
        camera.position.set(0,table_height,table_height*4);
        for(var i=0;i<table_n;i++){
            tables.push(new Table(table_height));
            tables[i].setPosition(i*table_height*2+i*basin_width,-table_height,0);
            scene.add(tables[i].Mesh);
            shelves.push(new Shelf(shelf_height));
            shelves[i].setPosition(i*shelf_height*2+i*basin_width,0,-table_height*0.43);
            scene.add(shelves[i].Mesh);
            basins.push(new Basin(basin_width));
            basins[i].setPosition((2*i+1)*table_height+((1/2)+i)*basin_width,-basin_height,0);
            scene.add(basins[i].Mesh);   
        }
        var dragControls =new THREE.DragControls(objectsM,camera,renderer.domElement);
        dragControls.addEventListener('dragstart',function (event){
            isclick=1;
            drag=1;
            var intersects = _raycaster.intersectObjects( pressobjects ); 
            if (intersects.length>0) {
                //console.log('here');
                drag=0;
            }
            controls.enabled=false;
            for(var i=0;i<objects.length;i++){
                if(_selected==objectsM[i]){
                    pobject=i;
                    prevcor=new THREE.Vector3(objects[i].x(),objects[i].y(),objects[i].z());
                    prevmaster=objects[i].Master;
                    if(prevmaster!=null){
                      prevslot=objects[i].Masterslot;
                      Dethrone(i,prevmaster,prevslot);
                    }
                    break;
                }
            }
            if(drag==1){
              if(objects[pobject].Master==null && typeof objects[pobject].pick =='function'){
                objects[pobject].pick(pobject);
              }
            }
        });
        function onDocumentMouseMove( event ){
            isclick=0;
        }
        renderer.domElement.addEventListener( 'mousemove', onDocumentMouseMove, false );
        dragControls.addEventListener('dragend',function (event){
            controls.enabled=true;
            if(drag==1){
              dobject=pobject;
            }
            objects[pobject].restrict(-table_height+objects[pobject].radius,-table_height+basin_width*table_n+table_height*2*table_n-objects[pobject].radius,0,table_height*2,0,0);
                  updatePos(objects[pobject]);
            pobject=null
        });
        document.getElementById('NewTable').addEventListener('click',function(){
            tables.push(new Table(table_height));
            tables[table_n].setPosition(table_n*table_height*2+table_n*basin_width,-table_height,0);
            scene.add(tables[table_n].Mesh);
            shelves.push(new Shelf(shelf_height));
            shelves[table_n].setPosition(table_n*shelf_height*2+table_n*basin_width,0,-table_height*0.43);
            scene.add(shelves[table_n].Mesh);
            basins.push(new Basin(basin_width));
            basins[table_n].setPosition((2*table_n+1)*table_height+((1/2)+table_n)*basin_width,-basin_height,0);
            scene.add(basins[table_n].Mesh);
            spotLight.push(new THREE.PointLight(0xffffff,0.4));
            spotLight[table_n].position.set(table_n*table_height*2+table_n*basin_width, 80, -60);
            spotLight[table_n].castShadow = true;
            scene.add(spotLight[table_n]);
            table_n++;
        });
        document.getElementById('Save').addEventListener('click',function(){
            var mystring = "";
            for(var i=0;i<objects.length;i++){
                mystring += "instantiate(new " + omap[objects[i].id] + "(" + objects[i].volume + "," + objects[i].Mixture.toString() + "))";
                mystring += "#";
                mystring += "move(objects[" + i + "]," + objects[i].x() + ',' + objects[i].y() + ',' + objects[i].z() + ")"; 
                mystring += "#";
            }
            mystring += "table_n=" + table_n.toString();
            var addFunc = function() {
            /* ajax request to add data into db */
                  $.ajax({
                      type: "POST",
                      url: "UploadSevlet",
                              data:{
                                    'id':mystring
                              },
                              error : function(){
                                  alert("Error Occured");
                              },
                              success: function(response) {
                                  alert("Successfull Entry of data");
                              }
                });
            }();
            console.log(mystring);
//            addFunc();
          
        });
        document.getElementById('Restore').addEventListener('click',function(){
            window.open('perform2.html')
        });
        var presstate=null;
        renderScene();
        var date=new Date();
        var st=date.getTime();
        var ct=st;
        var dt=0;
        var et;
        function renderScene() {
            date=new Date();
            var temp=date.getTime();
            dt=temp-ct;
            ct=temp;
            if(pobject!=null){
                if(drag){
                  objects[pobject].restrict(-table_height+objects[pobject].radius,-table_height+basin_width*table_n+table_height*2*table_n-objects[pobject].radius,0,table_height*2,0,0);
                  updatePos(objects[pobject]);
                }
                else{
                  if(presstate==null){
                    date=new Date();
                    st=date.getTime();
                    objects[pobject].onPress(presstate);
                  }
                  presstate=pobject;
                  objects[pobject].duringPress(presstate);
                  objects[pobject].setPosition(prevcor);
                }
            }
            if(presstate!=null && pobject==null){
              date=new Date();
              et=date.getTime();
              resetPosition(presstate);
              console.log("objects["+presstate.toString()+'].PressFor('+(et-st).toString()+')')
              objects[presstate].onPressEnd(presstate);
              presstate=null;
            }
            if(dobject!=null && drag && !isclick){
                var sobject=-1;
                var flag=0;
                if(!flag){
                  for(var i=0;i<table_n;i++){
                    if(Math.abs(objects[dobject].x()-basins[i].x())<basins[i].half_width){
                      console.log("wash("+dobject.toString()+','+i.toString()+')');
                      wash(dobject,i);
                      flag=1;
                      break;
                    }
                  }
                }
                if(!flag){
                  var lobject=-1;
                  for(var i=0;i<objects.length;i++){
                      if(!isSlave(i,dobject) &&objects[i]!=objects[dobject] &&(objects[i].y()==0)&& (Math.abs(objects[dobject].x()-objects[i].x())<= objects[i].half_width+objects[dobject].half_width)){
                          if(Place(dobject,i)){
                            flag=1;
                            break;
                          }
                      }
                  }
                }
                if(!flag){
                  var lobject=-1;
                  for(var i=0;i<objects.length;i++){
                      if(objects[i]!=objects[dobject] && !isSlave(i,dobject) &&(objects[i].z()==0)&& (Math.abs(objects[dobject].x()-objects[i].x())<= objects[i].half_width+objects[dobject].half_width)){
                          if((map[objects[dobject].id][objects[i].id]!=0)){
                            sobject=i;
                            flag=1;
                            break;
                          }
                          else{
                            flag=1;
                            lobject=i;
                          }
                      }
                  }
                  if(sobject>=0){
                    operate(dobject,sobject);
                    console.log("operate("+dobject.toString()+','+sobject.toString()+')');
                  }
                  else if(lobject>=0){
                    operate(dobject,lobject);
                    console.log("operate("+dobject.toString()+','+lobject.toString()+')');
                  }
                  else if(typeof objects[dobject].droppable=='function' && !objects[dobject].droppable()){
                    resetPosition(dobject);
                    flag=1;
                  }
                }
                if(!flag){
                  var s="";
                  s+="move(";
                  s+='objects[';
                  s+=dobject.toString();
                  s+='],';
                  s+=(objects[dobject].x()).toString();
                  s+=',0,0)';
                  if(typeof objects[dobject].drop == 'function'){
                    objects[dobject].drop(dobject);
                  }
                  console.log(s);
                  journal.push(s);
                  objects[dobject].sety(0);
                  objects[dobject].setz(0);
                  updatePos(objects[dobject]);
                }
                dobject=null;
                pobject=null;
            }
            if(dobject!=null && drag && isclick){
              resetPosition(dobject);
              if(typeof objects[dobject].onClick == 'function'){
                objects[dobject].onClick();
              }
              pobject=null;
              dobject=null;
            }
            controls.update();
            requestAnimationFrame(renderScene);
            renderer.render(scene, camera);
        }
    }
    window.onload = init;
</script>
</body>
</html>